<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.5">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2018-12-27T21:59:21+05:30</updated><id>http://localhost:4000/feed.xml</id><title type="html">Deep Code Dive</title><subtitle>Performance, Kernel programming, hacking and debugging.</subtitle><entry><title type="html">Building Custom Linux Kernel!</title><link href="http://localhost:4000/kernel/2018/12/27/building_custom_linux_kernel.html" rel="alternate" type="text/html" title="Building Custom Linux Kernel!" /><published>2018-12-27T20:06:36+05:30</published><updated>2018-12-27T20:06:36+05:30</updated><id>http://localhost:4000/kernel/2018/12/27/building_custom_linux_kernel</id><content type="html" xml:base="http://localhost:4000/kernel/2018/12/27/building_custom_linux_kernel.html">&lt;p&gt;Linux kernel is a nice piece of collaborative work developed by thousands of developers across the world. Hence it always feels proud to get our hands dirty with such art.&lt;/p&gt;

&lt;p&gt;This post gives a begineer’s guide to how to compile the kernel in your system for the first time and install it.&lt;/p&gt;

&lt;h4 id=&quot;get-the-kernel-sources&quot;&gt;Get the kernel sources&lt;/h4&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://www.github.com/torvalds/linux.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;build-the-dependencies&quot;&gt;Build the dependencies&lt;/h4&gt;
&lt;p&gt;Install packages for compiler, curses, flex, bison, etc based on your linux distro&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;For &lt;code class=&quot;highlighter-rouge&quot;&gt;dnf/yum&lt;/code&gt; based distro
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;dnf &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;bison automake autoconf flex ncurses-devel elfutils-libelf-devel make gcc elfutils-devel libunwind-devel xz-devel numactl-devel openssl-devel binutils-devel
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;For &lt;code class=&quot;highlighter-rouge&quot;&gt;apt&lt;/code&gt; based distro
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;flex libncurses5 elfutils openssl libssl-dev automake bison pkg-config libncurses5-dev
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;configure-kernel&quot;&gt;Configure kernel&lt;/h4&gt;
&lt;p&gt;Generally linux kernel has thousands of parameters and modules to be configured based on the system architecture.&lt;/p&gt;

&lt;p&gt;Linux kernel  maintains &lt;code class=&quot;highlighter-rouge&quot;&gt;.config&lt;/code&gt; file in root folder of kernel source tree. One can use any editor to configure the file but the curses based builtin tool makes it easy to change any configurations.&lt;/p&gt;

&lt;p&gt;For begginer’s one can get default config file for x86_64 platform by below command, while for other architectures like PowerPC,MIPS,arm64,etc. look thorugh &lt;code class=&quot;highlighter-rouge&quot;&gt;arch/&amp;lt;architecture name&amp;gt;/configs/&lt;/code&gt; folder to find proper name.&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;make x86_64_defconfig
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To traverse through the config file, just use &lt;code class=&quot;highlighter-rouge&quot;&gt;make menuconfig&lt;/code&gt; command to fire up curses based window for easier navigation.&lt;/p&gt;

&lt;h4 id=&quot;compile-kernel&quot;&gt;Compile kernel&lt;/h4&gt;
&lt;p&gt;Compiling of kernel goes through compilation of several files which may take time in several minutes to hours in typical desktop systems. The make with &lt;code class=&quot;highlighter-rouge&quot;&gt;-j&amp;lt;nr_threads&amp;gt;&lt;/code&gt; arguments helps out here by parallel building. &lt;code class=&quot;highlighter-rouge&quot;&gt;nproc&lt;/code&gt; total CPUs in the system here.&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;make &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nproc&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once compiled succesfully, the output is a &lt;code class=&quot;highlighter-rouge&quot;&gt;vmlinux&lt;/code&gt; file in the root directory which is basically the kernel.&lt;/p&gt;

&lt;h4 id=&quot;installing-kernel&quot;&gt;Installing kernel&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Kernel built vmlinux is the file which gets executed firstly after system boot, hence it cannot depend on any other code or library as it itself has the loader and linker. For this reason, the vmlinux file is statically build. The kernel installation gets done in three parts: installation of vmlinux, kernel modules and initrd image.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The vmlinux needs to copied at &lt;code class=&quot;highlighter-rouge&quot;&gt;/boot&lt;/code&gt; partition along with its &lt;code class=&quot;highlighter-rouge&quot;&gt;System.map&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;.config&lt;/code&gt; file as optional things.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;vmlinux&lt;/code&gt; contains module codes, which means it has capability to add some code to itself after it gets executed. This modules are basically drivers, energy governors, etc.  which needs to be added along ith the kernel. This can be invoked by &lt;code class=&quot;highlighter-rouge&quot;&gt;make modules_install&lt;/code&gt; which will compile relevant modules configured using &lt;code class=&quot;highlighter-rouge&quot;&gt;.config&lt;/code&gt; file and install it to &lt;code class=&quot;highlighter-rouge&quot;&gt;/lib/modules/&lt;/code&gt; directory.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;The system boot sequence is as follows:
    &lt;ol&gt;
      &lt;li&gt;The power on button invokes the system firmware/BIOS which in turn powers on motherboard components including disks.&lt;/li&gt;
      &lt;li&gt;The control is then passed on to the boot loader like GRUB/LILO seating in /boot partition of the disk. It is the one which provides options to select a kernel to be loaded.&lt;/li&gt;
      &lt;li&gt;The boot loader then invokes the initrd image which does mounting of several disk paritions like &lt;code class=&quot;highlighter-rouge&quot;&gt;/root&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;/home&lt;/code&gt;/, &lt;code class=&quot;highlighter-rouge&quot;&gt;/swap&lt;/code&gt;, etc. and boots vmlinux from there in.
The initrd thus has to be generated using &lt;code class=&quot;highlighter-rouge&quot;&gt;mkinitrd&lt;/code&gt; command and boot loader has to be updated for the new kernel addition.&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;The Makefile does all the above three steps and updates the boot loader using below command
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;make &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Manual method&lt;/strong&gt;
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;make modules_install &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nproc&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;Get kernel-version-name from &lt;code class=&quot;highlighter-rouge&quot;&gt;/include/config/kernel.release&lt;/code&gt; file.&lt;/p&gt;
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkinitramfs &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; initramfs-&amp;lt;kernel-version-name&amp;gt;.img &amp;lt;kernel-version-name&amp;gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;initramfs--&amp;lt;kernel-version-name&amp;gt;.img /boot
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; .config /boot/config--&amp;lt;kernel-version-name&amp;gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;System.map /boot/System.map--&amp;lt;kernel-version-name&amp;gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;vmlinux /boot/vmlinuz--&amp;lt;kernel-version-name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;booting-new-kernel&quot;&gt;Booting new kernel&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;If succesfully installed the new kernel, then one can reboot the system and find the kernel with its version installed in boot loader. Just select that kernel to start the system with your new kernel.
After system start one can use &lt;code class=&quot;highlighter-rouge&quot;&gt;uname -a&lt;/code&gt; to find the current kernel info.&lt;/li&gt;
  &lt;li&gt;Other way to start the new kernel is to build custom initrd from above manual steps and invoke below command
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kexec ./vmlinux &lt;span class=&quot;s2&quot;&gt;&quot;./initrd.img&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--append&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /proc/cmdline&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;The advantage of above kexec command is that it will load the new kernel without rebooting the system. Also even with just modul installation step only one can test this kernel without updating boot loader or &lt;code class=&quot;highlighter-rouge&quot;&gt;/boot&lt;/code&gt; partition.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;</content><author><name></name></author><summary type="html">Linux kernel is a nice piece of collaborative work developed by thousands of developers across the world. Hence it always feels proud to get our hands dirty with such art.</summary></entry></feed>