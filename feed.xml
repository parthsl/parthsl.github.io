<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.5">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2019-01-06T11:44:44+05:30</updated><id>http://localhost:4000/feed.xml</id><title type="html">Deep Code Dive</title><subtitle>Performance, Kernel programming, hacking and debugging.</subtitle><entry><title type="html">Pthread locks: Mutex vs Spilocks vs Futex!</title><link href="http://localhost:4000/index/2019/01/06/pthread_locks.html" rel="alternate" type="text/html" title="Pthread locks: Mutex vs Spilocks vs Futex!" /><published>2019-01-06T00:00:00+05:30</published><updated>2019-01-06T00:00:00+05:30</updated><id>http://localhost:4000/index/2019/01/06/pthread_locks</id><content type="html" xml:base="http://localhost:4000/index/2019/01/06/pthread_locks.html">&lt;h1 id=&quot;locking&quot;&gt;Locking&lt;/h1&gt;
&lt;p&gt;During multi-threading or multi-processing, the biggest challenge is selecting types of locks. When writing C code, one can manually write their own locking mechanism or can use glibc wrappers for Mutex and spinlocks.&lt;/p&gt;

&lt;h3 id=&quot;mutex-vs-spinlocks&quot;&gt;Mutex vs Spinlocks&lt;/h3&gt;
&lt;p&gt;Mutex are low overhead locking mechanism with the concept of sleeping the process when waiting for the lock. The mutex implements sleeping mechanism and relinquishes the CPU during that period. This gives way for other tasks to use that CPU.&lt;/p&gt;

&lt;p&gt;The drawback is that there can be cases when lock is available and the mutex is sleeping which may leave out the opportunity. Hence, this is used when critical section is large or there are lots of processes in CPU where allowing other threads can effectively increase throughput of the system.&lt;/p&gt;

&lt;p&gt;Unlike mutex, spinlocks differs in the manner of waiting for the lock. It constantly does busy-waiting over the lock without relinquishing the CPU. This is useful when critical section size is relatively small and/or with less processes in the system.&lt;/p&gt;

&lt;h3 id=&quot;futex&quot;&gt;Futex&lt;/h3&gt;
&lt;p&gt;Futex is userspace optimization of the mutex.&lt;/p&gt;

&lt;p&gt;Basically, mutex makes a &lt;code class=&quot;highlighter-rouge&quot;&gt;_syscall&lt;/code&gt; to the system where kernel handles all the locking, thus leaving the userspace. This can be useful when userspace don;t want overhead of maintaining the locking mechanisms as it has to do book-keeping.&lt;/p&gt;

&lt;p&gt;To solve those, linux kernel implements futex which tries to remain in the user-space for shorter time and acquires lock if available. It though goes to kernel space after specific threshold, it benefits those small critical sections where going to kernel and coming back is latency intensive.&lt;/p&gt;

&lt;p&gt;The futex is advantageous for kernel code like drivers and kernel modules which makes lots of &lt;code class=&quot;highlighter-rouge&quot;&gt;_syscall&lt;/code&gt;.&lt;/p&gt;

&lt;h1 id=&quot;programic-view&quot;&gt;Programic view&lt;/h1&gt;
&lt;hr /&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;pthread.h&amp;gt;
#include &amp;lt;unistd.h&amp;gt;
#include &amp;lt;sys/syscall.h&amp;gt;
#include &amp;lt;errno.h&amp;gt;
#include &amp;lt;sys/time.h&amp;gt;
#include &amp;lt;time.h&amp;gt;
#include &amp;lt;stdlib.h&amp;gt;
&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#ifdef USE_FUTEX
#include &amp;lt;linux/futex.h&amp;gt;
#include &amp;lt;syscall.h&amp;gt;
#endif
&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#ifndef LOOPS
#define LOOPS 10000000
#endif
&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LOOPS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;#ifdef USE_SPINLOCK
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pthread_spinlock_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;spinlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#else
#ifdef USE_FUTEX
&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;futex_addr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;futex_wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;val1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
	  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;syscall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SYS_futex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;futex_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;futex_wake&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
	  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;syscall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SYS_futex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FUTEX_WAKE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#else
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pthread_mutex_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mutex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#endif
#endif
&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;pid_t&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;gettid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;syscall&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__NR_gettid&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;consumer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Consumer TID %lu&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gettid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#ifdef USE_SPINLOCK
&lt;/span&gt;		&lt;span class=&quot;n&quot;&gt;pthread_spin_lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;spinlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#else
#ifdef USE_FUTEX
&lt;/span&gt;		&lt;span class=&quot;n&quot;&gt;futex_wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;futex_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#else
&lt;/span&gt;		&lt;span class=&quot;n&quot;&gt;pthread_mutex_lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mutex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#endif
#endif
&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;#ifdef USE_SPINLOCK
&lt;/span&gt;		&lt;span class=&quot;n&quot;&gt;pthread_spin_unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;spinlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#else
#ifdef USE_FUTEX
&lt;/span&gt;		&lt;span class=&quot;n&quot;&gt;futex_wake&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;futex_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//Program intended for 2 threads only&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#else
&lt;/span&gt;		&lt;span class=&quot;n&quot;&gt;pthread_mutex_unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mutex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#endif
#endif
&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LOOPS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;pthread_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeval&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tv1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tv2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;srand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;#ifdef USE_SPINLOCK
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;pthread_spin_init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;spinlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#else
#ifdef USE_FUTEX
#else
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;pthread_mutex_init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mutex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#endif
#endif
&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Creating the list content...&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LOOPS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Measuring time before starting the threads...&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gettimeofday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thread0_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thread1_id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;pthread_create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;consumer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;thread0_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;pthread_create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;consumer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;thread1_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;pthread_join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;pthread_join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// Measuring time after threads finished...&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gettimeofday&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv_usec&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tv2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv_usec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;tv2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv_sec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;tv2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv_usec&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Result - %ld.%ld&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tv2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv_sec&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tv1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv_sec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;tv2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv_usec&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tv1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tv_usec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;#ifdef USE_SPINLOCK
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;pthread_spin_destroy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;spinlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#else
#ifdef USE_FUTEX
#else
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;pthread_mutex_destroy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mutex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#endif
#endif
&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;or &lt;a href=&quot;https://github.com/parthsl/tools/tree/master/Programming_logic/Locks_in_pthreads&quot;&gt;Github&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;analysis-of-locking-in-c-mutex-vs-spinlocks-vs-futex&quot;&gt;Analysis of Locking in C: Mutex vs Spinlocks vs Futex&lt;/h2&gt;

&lt;p&gt;The program &lt;code class=&quot;highlighter-rouge&quot;&gt;pthread_locks.c&lt;/code&gt; contains code with the implementation of all the three locking mechanisms.
Once can get specific code for a lock with &lt;code class=&quot;highlighter-rouge&quot;&gt;-E&lt;/code&gt; parameter to gcc.
e.g. to get pre-processed code for Spinlocks only: &lt;code class=&quot;highlighter-rouge&quot;&gt;gcc pthread_locks.c -lpthread -DUSE_SPINLOCK -DLOOPS=100000000 -E | less&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;The program is intended for 2 parallel threads trying to complete &lt;code class=&quot;highlighter-rouge&quot;&gt;LOOPS&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&quot;how-to-compile&quot;&gt;How to compile&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;For use with Mutex: &lt;code class=&quot;highlighter-rouge&quot;&gt;gcc pthread_locks.c -lpthread -DLOOPS=100000000 -o mutex&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;For use with SPIN_LOCK: &lt;code class=&quot;highlighter-rouge&quot;&gt;gcc pthread_locks.c -lpthread -DUSE_SPINLOCK -DLOOPS=100000000 -o spinlock&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;For use with FUTEX: &lt;code class=&quot;highlighter-rouge&quot;&gt;gcc pthread_locks.c -lpthread -DUSE_FUTEX -DLOOPS=100000000 -o futex&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;analysis&quot;&gt;&lt;center&gt;Analysis&lt;/center&gt;&lt;/h2&gt;
&lt;hr /&gt;
&lt;h5 id=&quot;my-system-info-with-lscpu-command&quot;&gt;My system info with &lt;code class=&quot;highlighter-rouge&quot;&gt;lscpu&lt;/code&gt; command:&lt;/h5&gt;

&lt;p&gt;&lt;img src=&quot;/assets/lscpu.png&quot; alt=&quot;lscpu&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;we-will-use-perf-tool-to-analyse-the-workload-performance&quot;&gt;We will use &lt;code class=&quot;highlighter-rouge&quot;&gt;perf&lt;/code&gt; tool to analyse the workload performance.&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;h4 id=&quot;with-mutex&quot;&gt;With Mutex&lt;/h4&gt;
    &lt;p&gt;&lt;img src=&quot;/assets/mutex.png&quot; alt=&quot;`perf stat ./mutex.out`&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;h4 id=&quot;with-spinlock&quot;&gt;With Spinlock&lt;/h4&gt;
    &lt;p&gt;&lt;img src=&quot;/assets/spinlock.png&quot; alt=&quot;`perf stat ./spinlock.out`&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;h4 id=&quot;with-futex&quot;&gt;With Futex&lt;/h4&gt;
    &lt;p&gt;&lt;img src=&quot;/assets/futex.png&quot; alt=&quot;`perf stat ./futex.out`&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Use &lt;code class=&quot;highlighter-rouge&quot;&gt;perf&lt;/code&gt; tool to find the CPUs utilized to find the difference in all three mechanism.&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Futex will consume least CPU and Spinlock/Mutex the most.&lt;/li&gt;
  &lt;li&gt;Instructions per Cycles will be more in Futex, though the time taken by futex will be more.&lt;/li&gt;
  &lt;li&gt;Futex are user space optimization of mutexs and tries to make least syscalls leading to increase in IPC, but since it gets less cycles the time taken will be more.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;add-ons&quot;&gt;Add-ons:&lt;/h3&gt;
&lt;hr /&gt;
&lt;ul&gt;
  &lt;li&gt;Use &lt;code class=&quot;highlighter-rouge&quot;&gt;htop&lt;/code&gt; in other terminal to view the difference in CPU utilization for each execution.&lt;/li&gt;
  &lt;li&gt;Do &lt;code class=&quot;highlighter-rouge&quot;&gt;objdump -dS a.out&lt;/code&gt; on binary generated to see the changes in instructions. Compile with &lt;code class=&quot;highlighter-rouge&quot;&gt;-g&lt;/code&gt; in gcc to get more debug info for binary with &lt;code class=&quot;highlighter-rouge&quot;&gt;objdump&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name></name></author><summary type="html">Locking During multi-threading or multi-processing, the biggest challenge is selecting types of locks. When writing C code, one can manually write their own locking mechanism or can use glibc wrappers for Mutex and spinlocks.</summary></entry><entry><title type="html">Traversing My Learning Curve!</title><link href="http://localhost:4000/index/2018/12/31/traversing_my_learning_curve.html" rel="alternate" type="text/html" title="Traversing My Learning Curve!" /><published>2018-12-31T21:26:36+05:30</published><updated>2018-12-31T21:26:36+05:30</updated><id>http://localhost:4000/index/2018/12/31/traversing_my_learning_curve</id><content type="html" xml:base="http://localhost:4000/index/2018/12/31/traversing_my_learning_curve.html">&lt;h3 id=&quot;topic-to-understand&quot;&gt;Topic to understand&lt;/h3&gt;
&lt;ol&gt;
  &lt;li&gt;Linux Kernel compilation&lt;/li&gt;
  &lt;li&gt;Building compiler toolchain.&lt;a href=&quot;https://preshing.com/20141119/how-to-build-a-gcc-cross-compiler/&quot; target=&quot;_blank&quot;&gt;Manual way&lt;/a&gt;, &lt;a href=&quot;https://crosstool-ng.github.io/&quot; target=&quot;_blank&quot;&gt;crosstool-ng&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Cross compiling kernel&lt;/li&gt;
  &lt;li&gt;Building own gcc compiler.&lt;/li&gt;
  &lt;li&gt;Building cross  compiler for ARM64 and PowerPC targets&lt;/li&gt;
  &lt;li&gt;Mastering git&lt;/li&gt;
  &lt;li&gt;Using qemu (console based) for fun
    &lt;ul&gt;
      &lt;li&gt;Creating VM for x86_64, arm64, ppc64, etc.&lt;/li&gt;
      &lt;li&gt;Creating network devices&lt;/li&gt;
      &lt;li&gt;ftp, smba folder mounting from host to guest os&lt;/li&gt;
      &lt;li&gt;9p file system&lt;/li&gt;
      &lt;li&gt;virtual bridging&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Using gnu debugger(GDB)&lt;/li&gt;
  &lt;li&gt;Using qemu to debug kernel&lt;/li&gt;
  &lt;li&gt;Mastering bash shell and shell scripts.&lt;/li&gt;
  &lt;li&gt;ssh reverse tunneling&lt;/li&gt;
  &lt;li&gt;Writing device drivers&lt;/li&gt;
  &lt;li&gt;Writing custom JIT compilers &lt;a href=&quot;http://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html_&quot; target=&quot;_blank&quot;&gt;Hello World&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Writing custom malloc function(independent of glibc) &lt;a href=&quot;https://github.com/parthsl/tools/tree/master/Memory_allocator&quot; target=&quot;_blank&quot;&gt;URL&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Workload tuning
    &lt;ul&gt;
      &lt;li&gt;TLB cache optimization&lt;/li&gt;
      &lt;li&gt;Hugepages&lt;/li&gt;
      &lt;li&gt;Hyper threading tuning&lt;/li&gt;
      &lt;li&gt;Vectorization(AVX-512 and Altivec)&lt;/li&gt;
      &lt;li&gt;Scaling across multi-cores and many-cores&lt;/li&gt;
      &lt;li&gt;GPU offloading&lt;/li&gt;
      &lt;li&gt;MPI+OpenMP tuning for multi-processing with multi-threading for ditributed multi-core processing&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Performance debugging and tracing
    &lt;ul&gt;
      &lt;li&gt;perf tool&lt;/li&gt;
      &lt;li&gt;ftrace&lt;/li&gt;
      &lt;li&gt;kdump&lt;/li&gt;
      &lt;li&gt;voltron gdb&lt;/li&gt;
      &lt;li&gt;Berkely packet filter&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Custom initrd file creation
    &lt;ul&gt;
      &lt;li&gt;Compiling for native system as well as for cross-comilation&lt;/li&gt;
      &lt;li&gt;Writing own boot firmware for x86 systems&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;kernel scheduler optimization
    &lt;ul&gt;
      &lt;li&gt;Performance optimization&lt;/li&gt;
      &lt;li&gt;throughput and latency oriented by fair scheduling&lt;/li&gt;
      &lt;li&gt;energy impact due to scheduler&lt;/li&gt;
      &lt;li&gt;CPUFREQ(P-States) and CPUIDLE(C-states)&lt;/li&gt;
      &lt;li&gt;task packing&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Pandaboard based omap4 booting
    &lt;ul&gt;
      &lt;li&gt;Booting debian os on omap4 board&lt;/li&gt;
      &lt;li&gt;kernel compilation&lt;/li&gt;
      &lt;li&gt;manually kernel installation and booting&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Understand several benchmarks &lt;a href=&quot;https://github.com/parthsl/tools/tree/master/benchmarks&quot; target=&quot;_blank&quot;&gt;URL&lt;/a&gt;
    &lt;ul&gt;
      &lt;li&gt;stream triad : For L1,L2 and LLC cache size&lt;/li&gt;
      &lt;li&gt;stress-ng : Swiss knife of many benchmarks&lt;/li&gt;
      &lt;li&gt;TSPLIB : NP-Hard TSP based dataset&lt;/li&gt;
      &lt;li&gt;rt-app : Configurable AOSP based workload generator&lt;/li&gt;
      &lt;li&gt;redis : In-memory single thread database benchmark&lt;/li&gt;
      &lt;li&gt;YCSB : PLugin based database benchmarking system&lt;/li&gt;
      &lt;li&gt;SPEC : int and float based benchmark suite(2006 and 2017 versions)&lt;/li&gt;
      &lt;li&gt;schbench and hackbench : scheduler wakeup latency benchmarking&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Lock Optimization
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;http://lucteo.ro/2018/11/18/look-ma-no-locks/&quot; target=&quot;_blank&quot;&gt;No lock ds&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Chip Energy Measurement
    &lt;ul&gt;
      &lt;li&gt;[CPU Energy Meter] (https://github.com/parthsl/tools/tree/master/cpu-energy-meter){:target=”_blank”}&lt;/li&gt;
      &lt;li&gt;[Intel specific] (https://github.com/parthsl/tools/tree/master/RAPL_Energy_measurement){:target=”_blank”}&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&quot;stay-tuned-for-more-info-on-each-topic&quot;&gt;Stay tuned for more info on each topic!!!!&lt;/h4&gt;

&lt;h4 id=&quot;you-can-google-out-this-topic-for-better-understanding-if-you-are-eager-to-learn-fast&quot;&gt;You can google out this topic for better understanding if you are eager to learn fast.&lt;/h4&gt;</content><author><name></name></author><summary type="html">Topic to understand Linux Kernel compilation Building compiler toolchain.Manual way, crosstool-ng Cross compiling kernel Building own gcc compiler. Building cross compiler for ARM64 and PowerPC targets Mastering git Using qemu (console based) for fun Creating VM for x86_64, arm64, ppc64, etc. Creating network devices ftp, smba folder mounting from host to guest os 9p file system virtual bridging Using gnu debugger(GDB) Using qemu to debug kernel Mastering bash shell and shell scripts. ssh reverse tunneling Writing device drivers Writing custom JIT compilers Hello World Writing custom malloc function(independent of glibc) URL Workload tuning TLB cache optimization Hugepages Hyper threading tuning Vectorization(AVX-512 and Altivec) Scaling across multi-cores and many-cores GPU offloading MPI+OpenMP tuning for multi-processing with multi-threading for ditributed multi-core processing Performance debugging and tracing perf tool ftrace kdump voltron gdb Berkely packet filter Custom initrd file creation Compiling for native system as well as for cross-comilation Writing own boot firmware for x86 systems kernel scheduler optimization Performance optimization throughput and latency oriented by fair scheduling energy impact due to scheduler CPUFREQ(P-States) and CPUIDLE(C-states) task packing Pandaboard based omap4 booting Booting debian os on omap4 board kernel compilation manually kernel installation and booting Understand several benchmarks URL stream triad : For L1,L2 and LLC cache size stress-ng : Swiss knife of many benchmarks TSPLIB : NP-Hard TSP based dataset rt-app : Configurable AOSP based workload generator redis : In-memory single thread database benchmark YCSB : PLugin based database benchmarking system SPEC : int and float based benchmark suite(2006 and 2017 versions) schbench and hackbench : scheduler wakeup latency benchmarking Lock Optimization No lock ds Chip Energy Measurement [CPU Energy Meter] (https://github.com/parthsl/tools/tree/master/cpu-energy-meter){:target=”_blank”} [Intel specific] (https://github.com/parthsl/tools/tree/master/RAPL_Energy_measurement){:target=”_blank”}</summary></entry><entry><title type="html">Building Custom Linux Kernel!</title><link href="http://localhost:4000/kernel/2018/12/27/building_custom_linux_kernel.html" rel="alternate" type="text/html" title="Building Custom Linux Kernel!" /><published>2018-12-27T20:06:36+05:30</published><updated>2018-12-27T20:06:36+05:30</updated><id>http://localhost:4000/kernel/2018/12/27/building_custom_linux_kernel</id><content type="html" xml:base="http://localhost:4000/kernel/2018/12/27/building_custom_linux_kernel.html">&lt;p&gt;Linux kernel is a nice piece of collaborative work developed by thousands of developers across the world. Hence it always feels proud to get our hands dirty with such art.&lt;/p&gt;

&lt;p&gt;This post gives a begineer’s guide to how to compile the kernel in your system for the first time and install it.&lt;/p&gt;

&lt;h4 id=&quot;get-the-kernel-sources&quot;&gt;Get the kernel sources&lt;/h4&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://www.github.com/torvalds/linux.git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;build-the-dependencies&quot;&gt;Build the dependencies&lt;/h4&gt;
&lt;p&gt;Install packages for compiler, curses, flex, bison, etc based on your linux distro&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;For &lt;code class=&quot;highlighter-rouge&quot;&gt;dnf/yum&lt;/code&gt; based distro
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;dnf &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;bison automake autoconf flex ncurses-devel elfutils-libelf-devel make gcc elfutils-devel libunwind-devel xz-devel numactl-devel openssl-devel binutils-devel
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;For &lt;code class=&quot;highlighter-rouge&quot;&gt;apt&lt;/code&gt; based distro
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;flex libncurses5 elfutils openssl libssl-dev automake bison pkg-config libncurses5-dev
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;configure-kernel&quot;&gt;Configure kernel&lt;/h4&gt;
&lt;p&gt;Generally linux kernel has thousands of parameters and modules to be configured based on the system architecture.&lt;/p&gt;

&lt;p&gt;Linux kernel  maintains &lt;code class=&quot;highlighter-rouge&quot;&gt;.config&lt;/code&gt; file in root folder of kernel source tree. One can use any editor to configure the file but the curses based builtin tool makes it easy to change any configurations.&lt;/p&gt;

&lt;p&gt;For begginer’s one can get default config file for x86_64 platform by below command, while for other architectures like PowerPC,MIPS,arm64,etc. look thorugh &lt;code class=&quot;highlighter-rouge&quot;&gt;arch/&amp;lt;architecture name&amp;gt;/configs/&lt;/code&gt; folder to find proper name.&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;make x86_64_defconfig
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To traverse through the config file, just use &lt;code class=&quot;highlighter-rouge&quot;&gt;make menuconfig&lt;/code&gt; command to fire up curses based window for easier navigation.&lt;/p&gt;

&lt;h4 id=&quot;compile-kernel&quot;&gt;Compile kernel&lt;/h4&gt;
&lt;p&gt;Compiling of kernel goes through compilation of several files which may take time in several minutes to hours in typical desktop systems. The make with &lt;code class=&quot;highlighter-rouge&quot;&gt;-j&amp;lt;nr_threads&amp;gt;&lt;/code&gt; arguments helps out here by parallel building. &lt;code class=&quot;highlighter-rouge&quot;&gt;nproc&lt;/code&gt; total CPUs in the system here.&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;make &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nproc&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once compiled succesfully, the output is a &lt;code class=&quot;highlighter-rouge&quot;&gt;vmlinux&lt;/code&gt; file in the root directory which is basically the kernel.&lt;/p&gt;

&lt;h4 id=&quot;installing-kernel&quot;&gt;Installing kernel&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Kernel built vmlinux is the file which gets executed firstly after system boot, hence it cannot depend on any other code or library as it itself has the loader and linker. For this reason, the vmlinux file is statically build. The kernel installation gets done in three parts: installation of vmlinux, kernel modules and initrd image.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The vmlinux needs to copied at &lt;code class=&quot;highlighter-rouge&quot;&gt;/boot&lt;/code&gt; partition along with its &lt;code class=&quot;highlighter-rouge&quot;&gt;System.map&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;.config&lt;/code&gt; file as optional things.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;vmlinux&lt;/code&gt; contains module codes, which means it has capability to add some code to itself after it gets executed. This modules are basically drivers, energy governors, etc.  which needs to be added along ith the kernel. This can be invoked by &lt;code class=&quot;highlighter-rouge&quot;&gt;make modules_install&lt;/code&gt; which will compile relevant modules configured using &lt;code class=&quot;highlighter-rouge&quot;&gt;.config&lt;/code&gt; file and install it to &lt;code class=&quot;highlighter-rouge&quot;&gt;/lib/modules/&lt;/code&gt; directory.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;The system boot sequence is as follows:
    &lt;ol&gt;
      &lt;li&gt;The power on button invokes the system firmware/BIOS which in turn powers on motherboard components including disks.&lt;/li&gt;
      &lt;li&gt;The control is then passed on to the boot loader like GRUB/LILO seating in /boot partition of the disk. It is the one which provides options to select a kernel to be loaded.&lt;/li&gt;
      &lt;li&gt;The boot loader then invokes the initrd image which does mounting of several disk paritions like &lt;code class=&quot;highlighter-rouge&quot;&gt;/root&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;/home&lt;/code&gt;/, &lt;code class=&quot;highlighter-rouge&quot;&gt;/swap&lt;/code&gt;, etc. and boots vmlinux from there in.
The initrd thus has to be generated using &lt;code class=&quot;highlighter-rouge&quot;&gt;mkinitrd&lt;/code&gt; command and boot loader has to be updated for the new kernel addition.&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;The Makefile does all the above three steps and updates the boot loader using below command
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;make &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Manual method&lt;/strong&gt;
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;make modules_install &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;nproc&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;Get kernel-version-name from &lt;code class=&quot;highlighter-rouge&quot;&gt;/include/config/kernel.release&lt;/code&gt; file.&lt;/p&gt;
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkinitramfs &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; initramfs-&amp;lt;kernel-version-name&amp;gt;.img &amp;lt;kernel-version-name&amp;gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;initramfs--&amp;lt;kernel-version-name&amp;gt;.img /boot
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; .config /boot/config--&amp;lt;kernel-version-name&amp;gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;System.map /boot/System.map--&amp;lt;kernel-version-name&amp;gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;vmlinux /boot/vmlinuz--&amp;lt;kernel-version-name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;booting-new-kernel&quot;&gt;Booting new kernel&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;If succesfully installed the new kernel, then one can reboot the system and find the kernel with its version installed in boot loader. Just select that kernel to start the system with your new kernel.
After system start one can use &lt;code class=&quot;highlighter-rouge&quot;&gt;uname -a&lt;/code&gt; to find the current kernel info.&lt;/li&gt;
  &lt;li&gt;Other way to start the new kernel is to build custom initrd from above manual steps and invoke below command
    &lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kexec ./vmlinux &lt;span class=&quot;s2&quot;&gt;&quot;./initrd.img&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--append&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /proc/cmdline&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;The advantage of above kexec command is that it will load the new kernel without rebooting the system. Also even with just modul installation step only one can test this kernel without updating boot loader or &lt;code class=&quot;highlighter-rouge&quot;&gt;/boot&lt;/code&gt; partition.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;</content><author><name></name></author><summary type="html">Linux kernel is a nice piece of collaborative work developed by thousands of developers across the world. Hence it always feels proud to get our hands dirty with such art.</summary></entry></feed>